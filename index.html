<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VECTRA V9 | TITAN GOLD</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400&family=Rajdhani:wght@500;600;700&family=Orbitron:wght@500;700;900&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg: #09090b;
            --panel: #18181b;
            --border: #27272a;
            --accent: #3b82f6;
            --text: #e4e4e7;
            --text-dim: #a1a1aa;
            --btn-bg: #27272a;
            --active-bg: #3b82f6;
        }

        body.theme-white {
            --bg: #eef2f6;
            --panel: #ffffff;
            --border: #e2e8f0;
            --accent: #d4af37;
            --text: #1e293b;
            --text-dim: #64748b;
            --btn-bg: #f1f5f9;
            --active-bg: #d4af37;
        }

        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; transition: 0.3s; }
        body.theme-white { font-family: 'Cinzel', serif; }
        body.theme-white .font-tech { font-family: 'Rajdhani', sans-serif; }

        /* LAYOUT */
        .app-grid { display: grid; grid-template-columns: 350px 1fr; height: 100vh; }
        .sidebar { background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .main-stage { position: relative; background: #000; overflow: hidden; display: flex; flex-direction: column; }

        /* EDITOR */
        .editor-container { flex: 1; position: relative; }
        textarea {
            width: 100%; height: 100%; background: rgba(0,0,0,0.2); color: var(--text-dim);
            border: none; padding: 1rem; resize: none; outline: none;
            font-family: 'JetBrains Mono', monospace; font-size: 13px; line-height: 1.5;
        }
        body.theme-white textarea { background: #f8fafc; color: #334155; }

        /* CONTROLS */
        .controls { padding: 1.25rem; border-top: 1px solid var(--border); gap: 1.25rem; display: flex; flex-direction: column; overflow-y: auto; }
        .label { font-size: 0.7rem; font-weight: 700; color: var(--text-dim); letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.5rem; display: block; }
        
        .btn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .btn-row { display: flex; gap: 0.5rem; }
        
        .btn {
            padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border);
            background: var(--btn-bg); color: var(--text-dim); font-size: 0.8rem; font-weight: 600;
            cursor: pointer; transition: 0.2s; text-align: center; display: flex; align-items: center; justify-content: center;
            font-family: 'Rajdhani', sans-serif; flex: 1;
        }
        .btn:hover { border-color: var(--accent); color: var(--text); }
        .btn.active { background: var(--active-bg); border-color: var(--accent); color: #fff; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        
        .btn-action { background: var(--accent); color: white; border: none; padding: 0.75rem; font-size: 1rem; font-weight: 700; letter-spacing: 1px; }
        .btn-action:hover { filter: brightness(1.1); transform: scale(1.01); }

        /* PREVIEW AREA */
        .preview-header {
            height: 50px; background: var(--panel); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem;
        }
        .preview-wrapper {
            flex: 1; overflow: auto; 
            background-color: var(--bg);
            background-image: 
                linear-gradient(45deg, rgba(128,128,128,0.05) 25%, transparent 25%), 
                linear-gradient(-45deg, rgba(128,128,128,0.05) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, rgba(128,128,128,0.05) 75%), 
                linear-gradient(-45deg, transparent 75%, rgba(128,128,128,0.05) 75%);
            background-size: 20px 20px;
            display: flex; justify-content: center; align-items: flex-start; padding: 60px;
        }
        
        /* FRAME CONTAINER */
        #iframeContainer {
            transform-origin: top center; transition: transform 0.2s ease-out;
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.5); background: white;
        }
        iframe { border: none; background: white; display: block; }

        /* RENDER CURTAIN */
        #renderCurtain {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(9, 9, 11, 0.95); z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        #renderZone { position: absolute; top: 0; left: 0; pointer-events: none; opacity: 0; }
        
        .loading-bar { width: 240px; height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin-top: 24px; }
        .loading-progress { width: 0%; height: 100%; background: var(--accent); transition: width 0.3s; }
        
        /* Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--accent); margin-top: -6px; cursor: pointer; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: var(--border); border-radius: 2px; }
    </style>
</head>
<body>

    <!-- RENDER OVERLAY -->
    <div id="renderCurtain">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-white mb-4"></i>
        <h1 class="text-2xl font-bold text-white tracking-widest font-tech">RENDERING PIXELS</h1>
        <div class="loading-bar"><div class="loading-progress" id="progressBar"></div></div>
        <div id="renderZone"></div>
    </div>

    <div class="app-grid">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="p-5 border-b border-[var(--border)] flex justify-between items-center">
                <h1 class="text-xl font-black italic tracking-wider font-[Orbitron] body.theme-white:font-[Cinzel] text-[var(--accent)]">
                    VECTRA <span class="text-xs opacity-50 ml-1 not-italic font-mono text-[var(--text)]">TITAN</span>
                </h1>
                <button onclick="toggleTheme()" class="text-[var(--text-dim)] hover:text-[var(--accent)] transition"><i id="themeIcon" class="fa-solid fa-moon"></i></button>
            </div>
            
            <div class="editor-container">
                <textarea id="htmlInput" placeholder="<!-- Paste your HTML code here -->" spellcheck="false"></textarea>
                <div class="absolute bottom-4 right-4 flex gap-2">
                    <button onclick="pasteCode()" class="bg-[var(--btn-bg)] border border-[var(--border)] text-[var(--accent)] px-3 py-1.5 rounded text-xs font-bold hover:bg-[var(--accent)] hover:text-white transition tracking-wider">PASTE</button>
                    <button onclick="clearEditor()" class="bg-[var(--btn-bg)] border border-[var(--border)] text-red-400 px-3 py-1.5 rounded text-xs font-bold hover:bg-red-500 hover:text-white transition tracking-wider">WIPE</button>
                </div>
            </div>

            <div class="controls">
                <!-- Dimensions -->
                <div>
                    <div class="flex justify-between mb-2">
                        <span class="label">BASE WIDTH</span>
                        <span id="widthVal" class="text-xs font-mono text-[var(--accent)]">1920px</span>
                    </div>
                    <input type="range" id="widthSlider" min="300" max="4000" step="10" value="1920" class="w-full mb-3">
                    <div class="btn-row">
                        <button class="btn" onclick="setWidth(1920)">1920</button>
                        <button class="btn" onclick="setWidth(1440)">1440</button>
                        <button class="btn" onclick="setWidth(1080)">1080</button>
                    </div>
                </div>

                <!-- Aspect Ratio -->
                <div>
                    <span class="label">FIT / RATIO</span>
                    <!-- Fixed Ratio Buttons -->
                    <div class="btn-grid mb-2" id="ratioOptions">
                        <button class="btn" id="ar-auto" onclick="setRatio('auto')">AUTO</button>
                        <button class="btn active" id="ar-16-9" onclick="setRatio(1.777)">16:9</button>
                        <button class="btn" id="ar-4-3" onclick="setRatio(1.333)">4:3</button>
                        <button class="btn" id="ar-1-1" onclick="setRatio(1)">1:1</button>
                        <button class="btn" id="ar-9-16" onclick="setRatio(0.5625)">9:16</button>
                        <button class="btn" id="ar-21-9" onclick="setRatio(2.333)">21:9</button>
                    </div>
                    <p class="text-[10px] text-[var(--text-dim)] leading-tight" id="fitDesc">Fixed Aspect Ratio (16:9). Adds background if needed.</p>
                </div>

                <!-- Resolution -->
                <div>
                    <span class="label">OUTPUT SCALE</span>
                    <!-- Resolution Scale Buttons -->
                    <div class="btn-row" id="scaleOptions">
                        <button class="btn" onclick="setScale(2, this)">2K</button>
                        <button class="btn active" onclick="setScale(4, this)">4K</button>
                        <button class="btn" onclick="setScale(6, this)">6K</button>
                        <button class="btn" onclick="setScale(8, this)">8K</button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="pt-2 flex flex-col gap-3">
                    <button class="btn w-full gap-2 border-[var(--accent)] text-[var(--accent)]" onclick="openPreviewTab()">
                        <i class="fa-solid fa-external-link-alt"></i> NEW TAB PREVIEW
                    </button>
                    <div class="flex gap-2">
                        <button class="btn-action w-full rounded flex items-center justify-center gap-2" onclick="startRender('png')">
                            <i class="fa-solid fa-bolt"></i> RENDER PNG
                        </button>
                        <button class="btn w-1/3 font-bold" onclick="startRender('svg')">SVG</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN STAGE -->
        <div class="main-stage">
            <div class="preview-header">
                <div class="flex items-center gap-4">
                    <span class="text-xs font-bold text-[var(--accent)] tracking-widest">LIVE PREVIEW</span>
                    <span id="resLabel" class="text-xs font-mono text-[var(--text-dim)] border-l border-[var(--border)] pl-4">3840 x Auto</span>
                </div>
                
                <!-- Zoom -->
                <div class="flex items-center gap-1 bg-[var(--btn-bg)] rounded border border-[var(--border)] p-0.5">
                    <button onclick="adjustZoom(-0.1)" class="w-7 h-7 flex items-center justify-center text-[var(--text-dim)] hover:text-[var(--text)]"><i class="fa-solid fa-minus text-[10px]"></i></button>
                    <span id="zoomLabel" class="text-[10px] font-mono w-10 text-center text-[var(--accent)]">Fit</span>
                    <button onclick="adjustZoom(0.1)" class="w-7 h-7 flex items-center justify-center text-[var(--text-dim)] hover:text-[var(--text)]"><i class="fa-solid fa-plus text-[10px]"></i></button>
                </div>
            </div>

            <div class="preview-wrapper" id="viewport">
                <div id="iframeContainer">
                    <iframe id="previewFrame" scrolling="no"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        let state = {
            width: 1920,
            scale: 4, // Default 4K
            targetRatio: 1.777, // Default 16:9 (Fixed)
            zoom: 1.0,
            theme: 'galaxy'
        };

        // --- DOM ELEMENTS ---
        const els = {
            editor: document.getElementById('htmlInput'),
            iframe: document.getElementById('previewFrame'),
            container: document.getElementById('iframeContainer'),
            viewport: document.getElementById('viewport'),
            baseWidthInput: document.getElementById('baseWidth'),
            widthSlider: document.getElementById('widthSlider'),
            widthVal: document.getElementById('widthVal'),
            resLabel: document.getElementById('resLabel'),
            zoomLabel: document.getElementById('zoomLabel'),
            renderCurtain: document.getElementById('renderCurtain'),
            progressBar: document.getElementById('progressBar'),
            renderZone: document.getElementById('renderZone'),
            fitDesc: document.getElementById('fitDesc')
        };

        // --- INIT ---
        window.onload = () => {
            // Initialize with 16:9 active
            updatePreview();
            window.addEventListener('resize', fitToScreen);
        };

        // --- LOGIC ---
        els.editor.addEventListener('input', debounce(updatePreview, 400));
        els.widthSlider.addEventListener('input', (e) => setWidth(parseInt(e.target.value)));

        function setWidth(val) {
            state.width = val;
            els.widthSlider.value = val;
            els.widthVal.innerText = val + 'px';
            updatePreview();
        }

        function setRatio(ratio) {
            state.targetRatio = ratio;
            
            // Update Ratio Buttons
            const map = { 'auto':'ar-auto', '1.777':'ar-16-9', '1.333':'ar-4-3', '1':'ar-1-1', '0.5625':'ar-9-16', '2.333':'ar-21-9' };
            document.querySelectorAll('#ratioOptions .btn').forEach(b => b.classList.remove('active'));
            
            let key = 'auto';
            if (typeof ratio === 'number') {
                // Find closest float match
                for(let k in map) {
                    if (Math.abs(parseFloat(k) - ratio) < 0.01) {
                         document.getElementById(map[k]).classList.add('active');
                         break;
                    }
                }
            } else {
                document.getElementById('ar-auto').classList.add('active');
            }

            els.fitDesc.innerText = ratio === 'auto' 
                ? "Auto-Fit: Trims height exactly to content." 
                : "Fixed Aspect Ratio. Adds background if needed.";
            
            updatePreview();
        }

        function setScale(s, btn) {
            state.scale = s;
            // Use the fixed ID selector
            document.querySelectorAll('#scaleOptions .btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            updateDims();
        }

        function toggleTheme() {
            state.theme = state.theme === 'galaxy' ? 'white' : 'galaxy';
            document.body.className = state.theme === 'galaxy' ? '' : 'theme-white';
            document.getElementById('themeIcon').className = state.theme === 'galaxy' ? 'fa-solid fa-moon' : 'fa-solid fa-sun';
        }

        // --- UNIFIED HTML GENERATOR (TITAN CORE) ---
        function generateTitanHTML(width) {
            const raw = els.editor.value;
            const isAutoFit = state.targetRatio === 'auto';
            
            let css = `
                body { margin: 0; padding: 0; background: white; font-family: sans-serif; overflow-x: hidden; }
                img { max-width: 100%; height: auto; display: block; }
                ::-webkit-scrollbar { display: none; } /* Hide scrollbars in export */
            `;

            if (isAutoFit) {
                // AUTO FIT: Nuclear Reset + Height Fitting
                css += `
                    html, body { width: ${width}px; min-height: 0 !important; height: auto !important; overflow: visible !important; }
                    [class*="max-w-"] { max-width: 100% !important; }
                    .container, .w-full, .mx-auto { width: 100% !important; max-width: 100% !important; margin: 0 !important; }
                    table { width: 100% !important; table-layout: fixed !important; }
                    body > div { min-height: 100vh; }
                `;
            } else {
                // FIXED RATIO
                const h = width / state.targetRatio;
                css += `body { width: ${width}px; min-height: ${h}px; }`;
            }

            // Handle Full HTML vs Snippet
            if (raw.toLowerCase().includes('<html')) {
                return raw.replace('</head>', `<style>${css}</style></head>`);
            }
            return `<!DOCTYPE html><html><head>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
                <style>${css}</style>
                </head><body>${raw}</body></html>`;
        }

        // --- PREVIEW LOGIC ---
        function updatePreview() {
            const width = state.width;
            const fullHTML = generateTitanHTML(width);
            
            const doc = els.iframe.contentDocument || els.iframe.contentWindow.document;
            doc.open(); doc.write(fullHTML); doc.close();

            els.iframe.style.width = width + 'px';
            els.iframe.style.height = '100px'; // Reset

            els.iframe.onload = () => {
                setTimeout(() => {
                    const bodyH = els.iframe.contentDocument.documentElement.scrollHeight;
                    let finalH = bodyH;

                    if (state.targetRatio !== 'auto') {
                        finalH = Math.max(bodyH, width / state.targetRatio);
                    }
                    
                    els.iframe.style.height = finalH + 'px';
                    updateDims();
                    fitToScreen();
                }, 400);
            };
        }

        function updateDims() {
            const h = parseInt(els.iframe.style.height) || 0;
            els.resLabel.innerText = `OUTPUT: ${state.width * state.scale} x ${h * state.scale} px`;
        }

        function fitToScreen() {
            const w = state.width;
            const containerW = els.viewport.clientWidth - 80;
            const fitScale = Math.min(1, containerW / w);
            const totalScale = fitScale * state.zoom;
            
            els.container.style.transform = `scale(${totalScale})`;
            els.container.style.width = w + 'px';
            els.container.style.height = els.iframe.style.height;
            
            const visualH = parseInt(els.iframe.style.height) * totalScale;
            els.container.style.marginBottom = `-${parseInt(els.iframe.style.height) - visualH}px`;
            
            els.zoomLabel.innerText = `${Math.round(totalScale * 100)}%`;
        }

        function adjustZoom(delta) {
            state.zoom = Math.max(0.1, state.zoom + delta);
            fitToScreen();
        }

        // --- RENDER ENGINE ---
        async function startRender(format) {
            els.renderCurtain.style.display = 'flex';
            els.progressBar.style.width = '10%';
            
            const w = state.width;
            const fullHTML = generateTitanHTML(w);

            // SVG Path
            if (format === 'svg') {
                const h = parseInt(els.iframe.style.height) || w;
                
                const parser = new DOMParser();
                const doc = parser.parseFromString(fullHTML, 'text/html');
                const serializer = new XMLSerializer();
                let safeXHTML = serializer.serializeToString(doc.documentElement);
                safeXHTML = safeXHTML.replace(/&(?![a-zA-Z0-9#]+;)/g, '&amp;');

                let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="background:white;width:${w}px;height:${h}px">${safeXHTML}</div></foreignObject></svg>`;
                
                download(new Blob([svg], {type: 'image/svg+xml;charset=utf-8'}), 'VECTRA_Vector.svg');
                setTimeout(() => { els.renderCurtain.style.display = 'none'; }, 500);
                return;
            }

            // Raster Path
            await new Promise(r => setTimeout(r, 200));
            els.progressBar.style.width = '30%';

            els.renderZone.innerHTML = '';
            const container = document.createElement('iframe');
            container.style.width = w + 'px';
            container.style.height = '10px';
            container.style.border = 'none';
            container.style.opacity = '0'; 
            container.style.position = 'absolute';
            els.renderZone.appendChild(container);

            const doc = container.contentDocument;
            doc.open(); doc.write(fullHTML); doc.close();

            els.progressBar.style.width = '50%';
            await new Promise(r => setTimeout(r, 2500)); 

            const bodyH = doc.documentElement.scrollHeight;
            let renderH = bodyH;
            if (state.targetRatio !== 'auto') {
                renderH = Math.max(bodyH, w / state.targetRatio);
            }
            container.style.height = renderH + 'px';
            
            els.progressBar.style.width = '75%';

            try {
                const canvas = await html2canvas(doc.documentElement, {
                    scale: state.scale,
                    useCORS: true,
                    allowTaint: false,
                    width: w,
                    height: renderH,
                    windowWidth: w,
                    windowHeight: renderH,
                    backgroundColor: '#ffffff',
                    logging: false
                });

                els.progressBar.style.width = '100%';
                
                const blob = await new Promise(r => canvas.toBlob(r, format === 'png' ? 'image/png' : 'image/jpeg', 0.95));
                download(blob, `VECTRA_${w*state.scale}x${Math.round(renderH*state.scale)}.${format}`);

            } catch (e) {
                alert("Render Error: " + e.message);
            } finally {
                els.renderZone.innerHTML = '';
                els.renderCurtain.style.display = 'none';
                els.progressBar.style.width = '0%';
            }
        }

        function download(blob, name) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = name; a.click();
            URL.revokeObjectURL(url);
        }

        function openPreviewTab() {
            const width = state.width;
            const fullHTML = generateTitanHTML(width);
            
            // New Tab Engine (Direct Write)
            const win = window.open("", "_blank");
            if (win) {
                win.document.open();
                win.document.write(fullHTML);
                win.document.close();
                win.document.title = "VECTRA Preview";
            } else {
                alert("Please allow pop-ups to view the preview.");
            }
        }

        function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
        async function pasteCode() { try { els.editor.value = await navigator.clipboard.readText(); updatePreview(); } catch(e) { alert("Use Ctrl+V"); } }
        function clearEditor() { els.editor.value = ''; updatePreview(); }

    </script>
</body>
</html>
